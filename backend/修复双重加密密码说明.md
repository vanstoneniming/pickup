# 修复双重加密密码问题

## 问题说明

如果在之前的导入中，密码被双重加密了（导入时手动加密 + 模型钩子自动加密），需要重新导入这些蟹卡。

## 解决方案

### 方案一：重新导入（推荐）

1. **删除已导入的蟹卡记录**（如果数据不重要）

```sql
USE pickup_db;
DELETE FROM crab_cards WHERE status = 'unused';
```

2. **重新导入蟹卡**

使用明文密码重新导入，现在代码已经修复，不会再双重加密了。

### 方案二：如果知道原始密码

如果知道原始密码，可以手动更新：

```sql
USE pickup_db;

-- 更新密码（需要先用 Node.js 生成 bcrypt hash）
-- 例如，如果原始密码是 "123456"：
-- 在 Node.js 中运行：require('bcryptjs').hashSync('123456', 10)
-- 然后使用生成的 hash 更新

UPDATE crab_cards 
SET card_password = '$2a$10$生成的hash值' 
WHERE card_no = '卡号';
```

### 方案三：使用脚本检查

运行检查脚本：

```bash
cd backend
node fix-double-encrypted-passwords.js
```

## 代码修复说明

已修复导入逻辑：
- **之前**：导入时手动加密密码 + 模型钩子再次加密 = 双重加密 ❌
- **现在**：导入时使用明文密码，由模型钩子自动加密 = 单次加密 ✅

## 验证修复

修复后，可以测试：

1. 导入一张新卡（使用明文密码）
2. 使用该卡号和密码进行验证
3. 验证应该成功

## 注意事项

- 已经双重加密的密码无法直接修复（因为不知道原始密码）
- 需要重新导入这些蟹卡
- 新导入的卡不会再有这个问题

