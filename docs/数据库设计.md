# 数据库设计文档（简化版）

## 一、数据库概述

- **数据库类型**：MySQL 8.0+ / PostgreSQL 12+
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci

## 二、数据表设计

### 2.1 用户表 (users)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码（bcrypt加密） |
| role | ENUM('admin', 'customer') | NOT NULL, DEFAULT 'customer' | 角色 |
| phone | VARCHAR(20) | UNIQUE | 手机号 |
| email | VARCHAR(100) | UNIQUE | 邮箱 |
| real_name | VARCHAR(50) | | 真实姓名 |
| status | TINYINT | DEFAULT 1 | 状态（1:启用 0:禁用） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 2.2 蟹卡表 (crab_cards)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| card_no | VARCHAR(50) | UNIQUE, NOT NULL | 蟹卡编号 |
| card_password | VARCHAR(255) | NOT NULL | 蟹卡密码（bcrypt加密） |
| product_name | VARCHAR(200) | | 对应商品名称（固定） |
| product_specification | VARCHAR(200) | | 商品规格（固定） |
| status | ENUM('unused', 'used', 'cancelled') | NOT NULL, DEFAULT 'unused' | 状态（未使用/已使用/已作废） |
| used_at | DATETIME | | 使用时间（提货时间） |
| cancelled_at | DATETIME | | 作废时间 |
| cancelled_reason | VARCHAR(255) | | 作废原因 |
| created_at | DATETIME | NOT NULL | 创建时间（导入时间） |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**说明**：
- 蟹卡由外部制作，通过导入功能批量导入
- 密码使用 bcrypt 加密存储，防止数据库泄露
- 每个卡号对应固定的商品信息

### 2.3 提货记录表 (deliveries)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| card_id | BIGINT | FOREIGN KEY, NOT NULL | 蟹卡ID |
| card_no | VARCHAR(50) | NOT NULL | 蟹卡编号（快照） |
| delivery_date | DATE | NOT NULL | 提货日期 |
| shipping_address | VARCHAR(255) | NOT NULL | 收货地址 |
| shipping_contact | VARCHAR(50) | NOT NULL | 收货联系人 |
| shipping_phone | VARCHAR(20) | NOT NULL | 收货电话（已验证） |
| shipping_method | VARCHAR(50) | | 配送方式 |
| tracking_number | VARCHAR(100) | | 物流单号 |
| status | ENUM('pending', 'shipped', 'completed', 'cancelled') | NOT NULL, DEFAULT 'pending' | 状态 |
| remark | TEXT | | 备注 |
| shipped_at | DATETIME | | 发货时间 |
| completed_at | DATETIME | | 完成时间 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**说明**：
- 提货时验证卡密后直接登记信息
- 不需要选择商品，商品信息从蟹卡表获取
- 电话号码需要短信验证码验证

### 2.4 短信验证码表 (sms_codes)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| phone | VARCHAR(20) | NOT NULL | 手机号 |
| code | VARCHAR(10) | NOT NULL | 验证码 |
| type | VARCHAR(50) | NOT NULL | 验证码类型（delivery等） |
| used | TINYINT | DEFAULT 0 | 是否已使用（0:未使用 1:已使用） |
| expires_at | DATETIME | NOT NULL | 过期时间 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**：
- INDEX (phone, code, used)
- INDEX (expires_at)

## 三、数据库初始化脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS pickup_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE pickup_db;

-- 创建用户表
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'customer') NOT NULL DEFAULT 'customer',
    phone VARCHAR(20) UNIQUE,
    email VARCHAR(100) UNIQUE,
    real_name VARCHAR(50),
    status TINYINT DEFAULT 1,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_role (role),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建蟹卡表
CREATE TABLE crab_cards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    card_no VARCHAR(50) UNIQUE NOT NULL,
    card_password VARCHAR(255) NOT NULL COMMENT '密码（bcrypt加密）',
    product_name VARCHAR(200) COMMENT '对应商品名称',
    product_specification VARCHAR(200) COMMENT '商品规格',
    status ENUM('unused', 'used', 'cancelled') NOT NULL DEFAULT 'unused',
    used_at DATETIME,
    cancelled_at DATETIME,
    cancelled_reason VARCHAR(255),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_card_no (card_no)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建提货记录表
CREATE TABLE deliveries (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    card_id BIGINT NOT NULL,
    card_no VARCHAR(50) NOT NULL COMMENT '蟹卡编号（快照）',
    delivery_date DATE NOT NULL COMMENT '提货日期',
    shipping_address VARCHAR(255) NOT NULL,
    shipping_contact VARCHAR(50) NOT NULL,
    shipping_phone VARCHAR(20) NOT NULL COMMENT '已验证的手机号',
    shipping_method VARCHAR(50),
    tracking_number VARCHAR(100),
    status ENUM('pending', 'shipped', 'completed', 'cancelled') NOT NULL DEFAULT 'pending',
    remark TEXT,
    shipped_at DATETIME,
    completed_at DATETIME,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_card_id (card_id),
    INDEX idx_status (status),
    INDEX idx_delivery_date (delivery_date),
    FOREIGN KEY (card_id) REFERENCES crab_cards(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建短信验证码表
CREATE TABLE sms_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    phone VARCHAR(20) NOT NULL,
    code VARCHAR(10) NOT NULL,
    type VARCHAR(50) NOT NULL COMMENT '验证码类型',
    used TINYINT DEFAULT 0 COMMENT '是否已使用',
    expires_at DATETIME NOT NULL COMMENT '过期时间',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_phone_code (phone, code, used),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 插入默认管理员账户（密码：admin123，需要在实际使用时修改）
-- 密码使用 bcrypt 加密，这里仅为示例
INSERT INTO users (username, password, role, real_name, status) 
VALUES ('admin', '$2b$10$example_hashed_password', 'admin', '系统管理员', 1);
```

## 四、数据关系图

```
users (用户表)
  └── 1:N -> deliveries (提货记录)

crab_cards (蟹卡表)
  └── 1:N -> deliveries (提货记录)

sms_codes (短信验证码表)
  └── 独立表，用于验证手机号
```

## 五、安全说明

1. **密码加密**：所有密码（用户密码、蟹卡密码）都使用 bcrypt 加密存储
2. **数据库泄露防护**：即使数据库泄露，密码也无法直接使用
3. **验证码时效**：短信验证码设置过期时间（通常5-10分钟）
4. **验证码使用**：验证码使用后标记为已使用，防止重复使用
